<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Time Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashborad.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
    {% include 'theme/header.html' %}

    <div class="dashboard-container">
        <div class="welcome-section">
            <h1>Welcome, 
                {% if current_user.user_type == 'company' %}
                    {{ current_user.company_profile.get('company_name', 'User') }}
                {% else %}
                    {{ current_user.individual_profile.get('full_name', 'User') }}
                {% endif %}
            </h1>
            <p>Convert your CSV files to professional Excel reports</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form id="uploadForm" action="{{ url_for('convert') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="schema" id="selectedSchema" value="classic">
            
            <!-- Step 1: File Upload -->
            <div class="step-section active" id="step1">
                <h2>Step 1: Upload CSV File</h2>
                <div class="file-upload-area">
                    <input type="file" name="csv_file" id="csv_file" accept=".csv" required>
                    <label for="csv_file" class="file-label">
                        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 0 2 2h4M9 11v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9.414a1 1 0 0 0-.293-.707l-4.414-4.414A1 1 0 0 0 17.586 4H11a2 2 0 0 0-2 2"/>
                        </svg>
                        <span>Click to upload or drag and drop</span>
                        <small>CSV files only â€¢ Maximum 10MB</small>
                    </label>
                    <div id="fileInfo" class="file-info" style="display: none;">
                        <p><strong>ðŸ“„ File:</strong> <span id="fileName"></span></p>
                        <p><strong>ðŸ“Š Total Rows:</strong> <span id="rowCount"></span></p>
                    </div>
                </div>
                <button type="button" class="btn-primary" id="nextToSchema">
                    Next: Choose Schema
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>

            <!-- Step 2: Schema Selection -->
            <div class="step-section" id="step2">
                <h2>Step 2: Choose Report Schema</h2>
                <div class="schema-grid">
                    {% for key, schema in schemas.items() %}
                    <div class="schema-card" data-schema="{{ key }}">
                        <div class="schema-header">
                            <h3>{{ schema.name }}</h3>
                            <div class="schema-radio">
                                <input type="radio" name="schema_choice" value="{{ key }}" id="schema_{{ key }}" {% if key == 'classic' %}checked{% endif %}>
                            </div>
                        </div>
                        <p class="schema-description">{{ schema.description }}</p>
                        <div class="schema-preview">
                            <div class="preview-table">
                                {% for col in schema.columns %}
                                <div class="preview-col">{{ col }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="step-actions">
                    <button type="button" class="btn-secondary" id="backToFile">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back
                    </button>
                    <button type="button" class="btn-primary" id="nextToFilters">
                        Next: Configure Filters
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Step 3: Filters & Live Preview -->
            <div class="step-section" id="step3">
                <h2>Step 3: Configure Filters & Preview</h2>
                
                <!-- Tabbed Filters -->
                <div class="filters-container">
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-tab="columns">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:8px;vertical-align:middle;">
                                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                            </svg>
                            Columns
                        </div>
                        <div class="filter-tab" data-tab="projects">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:8px;vertical-align:middle;">
                                <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Projects
                        </div>
                        <div class="filter-tab" data-tab="clients">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:8px;vertical-align:middle;">
                                <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Clients
                        </div>
                        <div class="filter-tab" data-tab="users">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:8px;vertical-align:middle;">
                                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Users
                        </div>
                        <div class="filter-tab" data-tab="format">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;margin-right:8px;vertical-align:middle;">
                                <path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                            </svg>
                            Format
                        </div>
                    </div>

                    <div class="filter-content active" id="tab-columns">
                        <div class="filter-group">
                            <label>
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                                </svg>
                                Select Columns to Include
                            </label>
                            <div id="columnSelector" class="checkbox-group">
                                <!-- Dinamik olarak doldurulacak -->
                            </div>
                        </div>
                    </div>

                    <div class="filter-content" id="tab-projects">
                        <div class="filter-group">
                            <label for="projectSelect">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                </svg>
                                Filter by Project
                            </label>
                            <select name="projectSelect[]" id="projectSelect" multiple size="8">
                                <option value="" selected>All Projects</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-content" id="tab-clients">
                        <div class="filter-group">
                            <label for="clientSelect">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                                Filter by Client
                            </label>
                            <select name="clientSelect[]" id="clientSelect" multiple size="8">
                                <option value="" selected>All Clients</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-content" id="tab-users">
                        <div class="filter-group">
                            <label for="userSelect">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Filter by User
                            </label>
                            <select name="userSelect[]" id="userSelect" multiple size="8">
                                <option value="" selected>All Users</option>
                            </select>
                        </div>
                    </div>

                    <div class="filter-content" id="tab-format">
                        <div class="filter-group">
                            <label for="formatSelect">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Duration Format
                            </label>
                            <select name="formatSelect" id="formatSelect" size="2">
                                <option value="decimal" selected>Decimal (8.50 hours)</option>
                                <option value="hours">Time Format (8:30)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Live Preview -->
                <div class="preview-section">
                    <h3>
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Live Data Preview
                    </h3>
                    <div id="dataPreview" class="data-preview">
                        <p class="preview-placeholder">Upload a file to see preview</p>
                    </div>
                </div>

                <div class="step-actions">
                    <button type="button" class="btn-secondary" id="backToSchema">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back
                    </button>
                    <button type="submit" class="btn-success">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                        </svg>
                        Generate Report
                    </button>
                </div>
            </div>
        </form>
    </div>

    {% include 'theme/footer.html' %}

    <script src="{{ url_for('static', filename='dashboard.js') }}"></script>
</body>
</html>